<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Data Produk (Firebase + Auth)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Firebase SDK v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    input, button { margin: 3px; padding: 5px; font-size: 13px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #888; padding: 6px; text-align: center; font-size: 13px; }
    thead th { position: sticky; top: 0; background-color: #eee; z-index: 1; }
    #log { margin-top: 10px; color: darkred; font-size: 13px; }
    .table-wrapper { max-height: 400px; overflow-y: auto; margin-top: 15px; border: 1px solid #ccc; }
    #app { display: none; }
    #loginDiv { max-width: 300px; margin: auto; border: 1px solid #ccc; padding: 20px; border-radius: 6px; }
    @media print {
      body * { visibility: hidden; }
      .table-wrapper, .table-wrapper * { visibility: visible; }
      .table-wrapper { position: absolute; left: 0; top: 0; width: 100%; }
    }
  </style>
</head>
<body>

<div id="loginDiv">
  <h3>Login</h3>
  <input type="email" id="loginEmail" placeholder="Email"><br>
  <input type="password" id="loginPassword" placeholder="Password"><br>
  <button onclick="login()">Login</button>
  <div id="loginMsg" style="color:red; margin-top:5px;"></div>
</div>

<div id="app">
  <h2>Data Harga Produk (Firebase)</h2>
  <div>
    <button onclick="logout()">Logout</button>
    <span id="userRole"></span>
  </div>

  <!-- form tambah/edit -->
  <form id="form" style="margin-top:10px;">
    <input type="hidden" id="editId">
    <input type="month" id="periode" required>
    <input type="text" id="id" placeholder="ID" required>
    <input type="text" id="kelompok" placeholder="Kelompok">
    <input type="text" id="merk" placeholder="Merk" required>
    <input type="text" id="ukuran" placeholder="Ukuran" required>
    <input type="text" id="motif" placeholder="Motif" required>
    <input type="number" id="plRetail" placeholder="PL Retail">
    <input type="number" id="plPareto" placeholder="PL Pareto">
    <input type="number" id="kr100" placeholder="Kirim <100">
    <input type="number" id="kr100_300" placeholder="Kirim 100–300">
    <input type="number" id="kr300" placeholder="Kirim >300">
    <input type="number" id="as100" placeholder="Ambil <100">
    <input type="number" id="as100_300" placeholder="Ambil 100–300">
    <input type="number" id="as300" placeholder="Ambil >300">
    <input type="number" id="pt500" placeholder="Pareto 500–1000">
    <input type="number" id="pt1000" placeholder="Pareto >1000">
    <button type="submit">Tambah / Simpan</button>
  </form>

  <!-- filter & tools -->
  <div>
    <label>Filter Periode: <input type="month" id="filterPeriode" oninput="renderTable()"></label>
    <label>Cari Motif: <input type="text" id="filterMotif" oninput="renderTable()"></label>
    <label>Cari ID: <input type="text" id="filterID" oninput="renderTable()"></label>
    <label>Cari Merk: <input type="text" id="filterMerk" oninput="renderTable()"></label>
    <label>Cari Ukuran: <input type="text" id="filterUkuran" oninput="renderTable()"></label>
    <button onclick="resetForm()">Reset</button>
    <button id="btnExport" onclick="exportToExcel()">Ekspor Excel</button>
    <input type="file" id="importExcel" accept=".xlsx" onchange="importExcel(event)">
    <button onclick="window.print()">Print</button>
  </div>

  <!-- tabel -->
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Periode</th><th>ID</th><th>Kelompok</th><th>Merk</th><th>Ukuran</th><th>Motif</th>
          <th>PL Retail</th><th>PL Pareto</th>
          <th>Kirim <100</th><th>Kirim 100–300</th><th>Kirim >300</th>
          <th>Ambil <100</th><th>Ambil 100–300</th><th>Ambil >300</th>
          <th>Pareto 500–1000</th><th>Pareto >1000</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div id="log"></div>
</div>

<script>
  // === Firebase Init ===
  const firebaseConfig = {
    apiKey: "AIzaSyAEb254RV2xncyZwnh0RUfqrnSTOPSpw2E",
    authDomain: "strata-dc0dc.firebaseapp.com",
    projectId: "strata-dc0dc",
    storageBucket: "strata-dc0dc.firebasestorage.app",
    messagingSenderId: "515862931689",
    appId: "1:515862931689:web:56ab94adf03254aa622878",
    measurementId: "G-0LC4S8SKBJ"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const adminEmail = "mnu@smg.com";
  let currentUserRole = "user";
  let data = [];

  // === Login/Logout ===
  function login() {
    const email = loginEmail.value;
    const pass = loginPassword.value;
    auth.signInWithEmailAndPassword(email, pass)
      .then(() => { loginMsg.textContent = ""; })
      .catch(err => { loginMsg.textContent = "Login gagal: " + err.message; });
  }
  function logout() { auth.signOut(); }

  auth.onAuthStateChanged(user => {
    if (user) {
      loginDiv.style.display = "none";
      app.style.display = "block";
      currentUserRole = (user.email === adminEmail) ? "admin" : "user";
      userRole.textContent = "Login sebagai: " + currentUserRole;
      form.style.display = (currentUserRole === "admin") ? "block" : "none";
      btnExport.style.display = (currentUserRole === "admin") ? "inline-block" : "none";
      importExcel.style.display = (currentUserRole === "admin") ? "inline-block" : "none";
    } else {
      loginDiv.style.display = "block";
      app.style.display = "none";
    }
  });

  // === CRUD ===
  form.onsubmit = async e => {
    e.preventDefault();
    if (currentUserRole !== "admin") return;
    const row = getFormData();
    if (form.editId.value) {
      await db.collection("produkData").doc(form.editId.value).set(row);
    } else {
      const snap = await db.collection("produkData")
        .where("periode","==",row.periode)
        .where("id","==",row.id)
        .where("merk","==",row.merk)
        .where("ukuran","==",row.ukuran)
        .where("motif","==",row.motif).get();
      if (!snap.empty) { alert("❗ Duplikat ditemukan."); return; }
      await db.collection("produkData").add(row);
    }
    resetForm();
  };

  function getFormData() {
    return {
      periode: form.periode.value,
      id: form.id.value,
      kelompok: form.kelompok.value,
      merk: form.merk.value,
      ukuran: form.ukuran.value,
      motif: form.motif.value,
      plRetail: form.plRetail.value,
      plPareto: form.plPareto.value,
      kr100: form.kr100.value,
      kr100_300: form.kr100_300.value,
      kr300: form.kr300.value,
      as100: form.as100.value,
      as100_300: form.as100_300.value,
      as300: form.as300.value,
      pt500: form.pt500.value,
      pt1000: form.pt1000.value
    };
  }
  async function hapusData(id) { if (confirm("Yakin hapus?")) await db.collection("produkData").doc(id).delete(); }
  async function editData(id) {
    const doc = await db.collection("produkData").doc(id).get();
    const d = doc.data(); for (let k in d) { if (form[k]) form[k].value = d[k]; }
    form.editId.value = id;
  }
  function resetForm() { form.reset(); form.editId.value = ""; }

  // === Realtime Render ===
  db.collection("produkData").onSnapshot(snap => {
    data = []; snap.forEach(doc => data.push({...doc.data(), _id:doc.id}));
    renderTable();
  });

  function renderTable() {
    tableBody.innerHTML = "";
    const fP=filterPeriode.value,fM=filterMotif.value.toLowerCase(),
          fID=filterID.value.toLowerCase(),fMerk=filterMerk.value.toLowerCase(),
          fU=filterUkuran.value.toLowerCase();
    data.forEach(d=>{
      const match=(!fP||d.periode.startsWith(fP))&&(!fM||d.motif.toLowerCase().includes(fM))&&
                  (!fID||d.id.toLowerCase().includes(fID))&&(!fMerk||d.merk.toLowerCase().includes(fMerk))&&
                  (!fU||d.ukuran.toLowerCase().includes(fU));
      if(match){
        const aksi=(currentUserRole==="admin")?`<button onclick="editData('${d._id}')">Edit</button><button onclick="hapusData('${d._id}')">Hapus</button>`:"-";
        tableBody.insertAdjacentHTML("beforeend",`
          <tr>
            <td>${d.periode}</td><td>${d.id}</td><td>${d.kelompok}</td><td>${d.merk}</td><td>${d.ukuran}</td><td>${d.motif}</td>
            <td>${d.plRetail}</td><td>${d.plPareto}</td><td>${d.kr100}</td><td>${d.kr100_300}</td><td>${d.kr300}</td>
            <td>${d.as100}</td><td>${d.as100_300}</td><td>${d.as300}</td><td>${d.pt500}</td><td>${d.pt1000}</td>
            <td>${aksi}</td>
          </tr>`);
      }
    });
  }

  // === Export Excel sesuai urutan tabel web ===
  function exportToExcel() {
    if (currentUserRole !== "admin") return;
    const headers = Array.from(document.querySelectorAll("thead th")).map(th=>th.innerText).filter(h=>h!=="Aksi");
    const ordered = data.map(d=>({
      "Periode":d.periode,"ID":d.id,"Kelompok":d.kelompok,"Merk":d.merk,"Ukuran":d.ukuran,"Motif":d.motif,
      "PL Retail":d.plRetail,"PL Pareto":d.plPareto,"Kirim <100":d.kr100,"Kirim 100–300":d.kr100_300,"Kirim >300":d.kr300,
      "Ambil <100":d.as100,"Ambil 100–300":d.as100_300,"Ambil >300":d.as300,"Pareto 500–1000":d.pt500,"Pareto >1000":d.pt1000
    }));
    const exportData = ordered.length>0?ordered:[Object.fromEntries(headers.map(h=>[h,""]))];
    const ws=XLSX.utils.json_to_sheet(exportData,{header:headers});
    const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Produk");XLSX.writeFile(wb,"DataProduk.xlsx");
  }

  // === Import Excel normalisasi periode ===
  async function importExcel(e) {
    const reader=new FileReader();
    reader.onload=async evt=>{
      const wb=XLSX.read(evt.target.result,{type:"binary"});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const imported=XLSX.utils.sheet_to_json(ws);
      let add=0,dup=0,fail=0;
      for(let r of imported){
        try{
          if(r.periode)r.periode=r.periode.toString().substring(0,7).trim();
          ["id","merk","ukuran","motif"].forEach(k=>{if(r[k])r[k]=r[k].toString().trim();});
          const snap=await db.collection("produkData")
            .where("periode","==",r.periode).where("id","==",r.id)
            .where("merk","==",r.merk).where("ukuran","==",r.ukuran)
            .where("motif","==",r.motif).get();
          if(snap.empty){await db.collection("produkData").add(r);add++;}else{dup++;}
        }catch(err){console.error("Gagal:",err);fail++;}
      }
      log.textContent=`✅ Import selesai: ${add} ditambahkan, ${dup} duplikat, ${fail} gagal.`;
    };
    reader.readAsBinaryString(e.target.files[0]);
  }
</script>
</body>
</html>